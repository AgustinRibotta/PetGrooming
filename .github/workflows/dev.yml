name: CI - Dev

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - 'backEnd/hairdressin/kubernetes/app-deployment.yaml'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Set environment variables from secrets
        env:
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_URL: ${{ secrets.DB_URL }}
          SERVER_PORT: ${{ secrets.SERVER_PORT }}
        run: |
          echo "DB_USERNAME: $DB_USERNAME"
          echo "DB_PASSWORD: $DB_PASSWORD"
          echo "DB_URL: $DB_URL"
          echo "SERVER_PORT: $SERVER_PORT"
    
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Check Last Commit Author
        run: |
          LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          if [ "$LAST_COMMIT_AUTHOR" = "GitHub Actions" ]; then
            echo "The last commit was made by GitHub Actions. No further commit will be made."
            exit 0
          fi

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Generate version using timestamp
        id: generate_version
        run: |
          VERSION=$(date +'%Y%m%d%H%M%S') 
          echo "Generated version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV  

      - name: Build Java application using Maven
        run: |
          cd backEnd
          mvn clean install -DskipTests

      - name: Verify VERSION variable
        run: echo "The generated version is:$VERSION"
        
      - name: Authenticate with Docker Hub
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build and Push Docker Image
        run: |
          cd backEnd
          docker build -t agustinribotta/hairdresin-app:$VERSION .
          docker push agustinribotta/hairdresin-app:$VERSION

      - name: Update Docker Image Version in Deployment YAML
        run: |
          cd backEnd/hairdressin/kubernetes
          VERSION=${{ env.VERSION }}
          sed -i "s|agustinribotta/hairdresin-app:.*|agustinribotta/hairdresin-app:$VERSION|" app-deployment.yaml
          echo "" >> app-deployment.yaml  # Si necesitas hacer algo con este archivo tambi√©n

      - name: Check if there are changes
        run: git status

      - name: Commit and Push Changes
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git remote set-url origin git@github.com:AgustinRibotta/PetGrooming.git

          if git diff --quiet backEnd/hairdressin/kubernetes/app-deployment.yaml; then
            echo "No changes to commit"
          else
            git add backEnd/hairdressin/kubernetes/app-deployment.yaml
            git commit -m "Update image to version $VERSION"
            git push origin dev
          fi
